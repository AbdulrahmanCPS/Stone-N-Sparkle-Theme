name: Backup + Deploy theme3 to GoDaddy (Managed WP)

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-theme3
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.GODADDY_HOST }}" >> ~/.ssh/known_hosts

      - name: Pre-deploy backup (theme3)
        run: |
          TS=$(date -u +"%Y%m%d-%H%M%S")
          ssh "${{ secrets.GODADDY_USER }}@${{ secrets.GODADDY_HOST }}" "\
            set -e; \
            cd ~/html/wp-content/themes; \
            if [ ! -d theme3 ]; then echo 'theme3 not found at ~/html/wp-content/themes/theme3'; exit 1; fi; \
            mkdir -p ~/backups/themes; \
            tar -czf ~/backups/themes/theme3-${TS}.tar.gz theme3; \
            ln -sfn ~/backups/themes/theme3-${TS}.tar.gz ~/backups/themes/theme3-latest.tar.gz; \
            ls -1t ~/backups/themes/theme3-*.tar.gz | tail -n +11 | xargs -r rm -f; \
            echo Backup created: ~/backups/themes/theme3-${TS}.tar.gz \
          "

      - name: Deploy via GoDaddy WordPress Deployer
        uses: godaddy-wordpress/gd-wordpress-deployer@v1
        with:
          remote_host: ${{ secrets.GODADDY_HOST }}
          ssh_user: ${{ secrets.GODADDY_USER }}
          ssh_private_key: ${{ secrets.PRIVATE_KEY }}
          deployment_dest: "wp-content/themes/theme3/"
